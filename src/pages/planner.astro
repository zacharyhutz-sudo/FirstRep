---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - AI Workout Planner">
	<main class="max-w-md mx-auto px-6 py-12 pb-32">
		<header class="flex items-center gap-4 mb-10">
			<a href="/FirstRep/workouts" class="p-2 -ml-2 text-gray-400 hover:text-white transition">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
			</a>
			<h1 class="text-2xl font-black text-white">Planner</h1>
		</header>

		<!-- Questionnaire Card -->
		<div id="quiz-container" class="bg-gray-900 border border-gray-800 rounded-3xl p-6 mb-8">
			<h2 class="text-lg font-bold mb-1">Create New Plan</h2>
			<p class="text-gray-500 text-xs mb-8">AI will build a routine based on your goals.</p>
			
			<form id="quiz-form" class="space-y-6">
				<div>
					<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Primary Goal</label>
					<select id="goal" class="w-full bg-gray-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
						<option value="Build Muscle">Build Muscle</option>
						<option value="Lose Weight">Lose Weight</option>
						<option value="Strength">Strength</option>
					</select>
				</div>
				<div class="grid grid-cols-2 gap-4">
					<div>
						<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Days / Week</label>
						<select id="daysPerWeek" class="w-full bg-gray-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
							<option value="2">2 Days</option>
							<option value="3" selected>3 Days</option>
							<option value="4">4 Days</option>
							<option value="5">5 Days</option>
						</select>
					</div>
					<div>
						<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Equipment</label>
						<select id="equipment" class="w-full bg-gray-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
							<option value="Full Gym">Full Gym</option>
							<option value="Dumbbells Only">Dumbbells</option>
							<option value="Bodyweight Only">Bodyweight</option>
						</select>
					</div>
				</div>
				<div>
					<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Experience Level</label>
					<select id="experience" class="w-full bg-gray-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
						<option value="Beginner">Beginner (0-1 years)</option>
						<option value="Experienced">Experienced (1+ years)</option>
					</select>
				</div>
				<div>
					<label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Preferred Training Style</label>
					<select id="splitStyle" class="w-full bg-gray-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
						<option value="Full Body">Full Body (Every muscle each day)</option>
						<option value="Split Style">Targeted Split (Push/Pull, Upper/Lower, etc)</option>
					</select>
				</div>
				<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-2xl transition shadow-lg shadow-indigo-500/20 active:scale-95">
					Generate Plan
				</button>
			</form>
		</div>

		<!-- Active Plan Display -->
		<div id="plan-display" class="hidden space-y-8">
			<div class="bg-indigo-500/10 border border-indigo-500/20 p-6 rounded-3xl relative overflow-hidden group">
				<div class="relative z-10">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 id="plan-name" class="text-xl font-black text-indigo-400 italic"></h2>
                            <p id="plan-schedule" class="text-[10px] text-gray-500 font-black uppercase tracking-widest"></p>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-save-current" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full transition shadow-lg shadow-indigo-500/20 active:scale-90">
                                Save Plan
                            </button>
                            <button id="btn-generate-new" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full transition active:scale-90">
                                New
                            </button>
                        </div>
                    </div>
				</div>
                <div class="absolute right-[-10%] bottom-[-20%] text-indigo-500/5 group-hover:text-indigo-500/10 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                </div>
			</div>
			
			<div id="workout-container" class="space-y-6">
				<!-- Injected -->
			</div>
		</div>
	</main>

	<!-- Nav Bar -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-xl border-t border-gray-800 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-500">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[10px] font-bold">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-indigo-500">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
				<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
				<path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
			</svg>
			<span class="text-[10px] font-bold">Workouts</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-500">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[10px] font-bold">Macros</span>
		</a>
	</nav>
</Layout>

<!-- Exercise Detail Modal -->
<div id="modal-overlay" class="hidden fixed inset-0 bg-black/90 backdrop-blur-xl z-[100] flex items-end sm:items-center justify-center">
    <div class="bg-gray-900 border-t sm:border border-gray-800 w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] overflow-hidden shadow-2xl max-h-[92vh] flex flex-col">
        <div class="sm:hidden w-12 h-1.5 bg-gray-800 rounded-full mx-auto mt-4 mb-2"></div>
        <div class="relative h-64 bg-gray-800 flex items-center justify-center overflow-hidden shrink-0">
            <img id="modal-image" src="" alt="" class="w-full h-full object-cover" />
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent"></div>
            <button id="modal-close" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full backdrop-blur-md border border-white/10 active:scale-90 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-8 overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-black text-white italic tracking-tighter mb-1"></h2>
            <p id="modal-muscles" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-8"></p>
            <div class="space-y-6">
                <h3 class="text-xs font-black text-gray-500 uppercase tracking-[0.2em]">Form Instructions</h3>
                <ul id="modal-instructions" class="space-y-4 text-gray-300"></ul>
            </div>
        </div>
    </div>
</div>

<script>
	import { supabase } from '../lib/supabase';
    import exerciseDB from '../data/exercise-db.json';

	const form = document.getElementById('quiz-form');
	const quizContainer = document.getElementById('quiz-container');
	const planDisplay = document.getElementById('plan-display');
    const btnSaveCurrent = document.getElementById('btn-save-current');
    const btnGenerateNew = document.getElementById('btn-generate-new');

    const modalOverlay = document.getElementById('modal-overlay');
    const modalClose = document.getElementById('modal-close');

	const WORKER_URL = 'https://first-rep-worker.hutzellcreativeco.workers.dev/';
    let currentGeneratedPlan = null;

    function openExerciseModal(name) {
        const data = exerciseDB.exercises.find((e) => e.name.toLowerCase() === name.toLowerCase());
        if (!data) return;
        document.getElementById('modal-title').innerText = data.name;
        document.getElementById('modal-muscles').innerText = `Target: ${data.muscles}`;
        document.getElementById('modal-image').src = data.image;
        document.getElementById('modal-instructions').innerHTML = data.instructions.map((i) => `
            <li class="flex gap-4">
                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-indigo-500/10 text-indigo-400 text-[10px] flex items-center justify-center font-black border border-indigo-500/20 mt-0.5">â€¢</span>
                <span class="text-sm font-medium leading-relaxed">${i}</span>
            </li>
        `).join('');
        modalOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    window.openExerciseModal = openExerciseModal;

    modalClose.addEventListener('click', () => {
        modalOverlay.classList.add('hidden');
        document.body.style.overflow = '';
    });

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) {
			window.location.href = '/FirstRep/login/index.html';
			return;
		}
	}

	function renderPlan(plan) {
        currentGeneratedPlan = plan;
		quizContainer.classList.add('hidden');
		planDisplay.classList.remove('hidden');
		document.getElementById('plan-name').innerText = plan.name;
		document.getElementById('plan-schedule').innerText = plan.schedule || (plan.metadata ? plan.metadata.days + ' days/week' : '');

		const container = document.getElementById('workout-container');
		container.innerHTML = plan.days.map((day) => `
			<div class="bg-gray-900 border border-gray-800 rounded-3xl p-5 shadow-sm">
				<h3 class="font-black text-indigo-400 mb-4 border-b border-gray-800 pb-2 italic uppercase tracking-widest text-xs">${day.day_label || day.label}</h3>
				<div class="space-y-4">
					${day.exercises.map((ex) => `
						<div class="flex justify-between items-center group cursor-pointer active:scale-95 transition" onclick="window.openExerciseModal('${(ex.exercise || ex.name).replace(/'/g, "\\'")}')">
							<div class="min-w-0 flex-1">
								<p class="text-sm font-bold text-gray-200 group-hover:text-indigo-400 transition">${ex.exercise || ex.name}</p>
								<p class="text-[10px] text-gray-600 font-bold uppercase tracking-tight">${ex.rest} rest</p>
							</div>
							<p class="text-indigo-400 font-black text-sm">${ex.sets} x ${ex.reps}</p>
						</div>
					`).join('')}
				</div>
			</div>
		`).join('');
	}

    btnGenerateNew?.addEventListener('click', () => {
        currentGeneratedPlan = null;
        planDisplay.classList.add('hidden');
        quizContainer.classList.remove('hidden');
    });

    btnSaveCurrent?.addEventListener('click', async () => {
        if (!currentGeneratedPlan) return;
        const btn = btnSaveCurrent as HTMLButtonElement;
        const originalText = btn.innerText;
        btn.innerText = 'SAVING...';
        btn.disabled = true;

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        try {
            console.log("Raw AI Plan:", currentGeneratedPlan);
            
            // AI plans usually have a 'days' array. Each day has 'exercises'.
            // For now, we'll flatten the first day's exercises for the logger.
            const firstDay = currentGeneratedPlan.days?.[0] || currentGeneratedPlan.workouts?.[0];
            const allExercises = firstDay?.exercises || [];
            
            console.log("Extracted Exercises:", allExercises);

            const mappedExercises = allExercises.map((ex: any) => ({
                exercise_name: ex.exercise || ex.name || "Unknown Exercise",
                sets: parseInt(ex.sets) || 3,
                reps: parseInt(ex.reps) || 12,
                rest: ex.rest || '90s'
            }));

            const payload = {
                user_id: user.id,
                plan_name: currentGeneratedPlan.name || "New Workout Plan",
                schedule_summary: currentGeneratedPlan.schedule || (currentGeneratedPlan.metadata ? currentGeneratedPlan.metadata.days + ' days/week' : 'Custom Plan'),
                plan_data: currentGeneratedPlan,
                exercises: mappedExercises,
                is_active: true
            };

            console.log("Pushing Payload to Supabase:", payload);

            const { error } = await supabase.from('workout_plans').insert([payload]);

            if (error) {
                console.error("Supabase Insertion Error:", error);
                throw error;
            }
            
            btn.innerText = 'SAVED!';
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (err) {
            console.error('Save error:', err);
            btn.innerText = 'ERROR';
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }
    });

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const btn = form.querySelector('button');
		btn.innerText = 'ðŸ¤– Building...';

		const { data: { user } } = await supabase.auth.getUser();
		if (!user) return;

		const formData = {
			goal: document.getElementById('goal').value,
			daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
			equipment: document.getElementById('equipment').value,
			experience: document.getElementById('experience').value,
			split: document.getElementById('splitStyle').value,
			age: 25, 
			sex: 'male', 
			injuries: 'None', 
			lastWorkout: 'Never',
			sessionTime: 60
		};

		const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
		if (profile) {
			formData.age = profile.age || 25;
			formData.sex = profile.sex || 'male';
			formData.injuries = profile.injuries || 'None';
		}

		try {
			const res = await fetch(WORKER_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(formData)
			});
			
			if (!res.ok) {
				const errorText = await res.text();
				throw new Error(`Worker response failed (${res.status}): ${errorText.substring(0, 100)}`);
			}
			const plan = await res.json();
            renderPlan(plan);
		} catch (err) {
			console.error('Planner error:', err);
			alert('Failed to generate plan: ' + err.message);
		} finally {
			btn.innerText = 'Generate Plan';
		}
	});

	init();
</script>
