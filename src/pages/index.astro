---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Dashboard">
	<main class="max-w-md mx-auto px-6 py-12 pb-32">
		<!-- Activity Rings / Summary (Native Style) -->
		<div class="bg-gray-900 border border-gray-800 rounded-3xl p-6 mb-8 shadow-sm">
			<div class="flex justify-between items-center mb-6">
				<h2 class="text-sm font-bold uppercase tracking-widest text-gray-500">Today's Summary</h2>
				<span id="date-display" class="text-xs text-indigo-400 font-bold">Feb 16</span>
			</div>
			
			<div class="grid grid-cols-2 gap-6">
				<div class="flex items-center gap-4">
					<div class="relative w-12 h-12">
						<svg class="w-12 h-12 -rotate-90">
							<circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" class="text-gray-800"/>
							<circle id="cal-ring" cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" stroke-dasharray="125.6" stroke-dashoffset="125.6" class="text-indigo-500 transition-all duration-1000"/>
						</svg>
						<div class="absolute inset-0 flex items-center justify-center">
							<span class="text-[10px]">ðŸ”¥</span>
						</div>
					</div>
					<div>
						<p id="summary-cals" class="text-lg font-black leading-none">0</p>
						<p class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">Calories</p>
					</div>
				</div>
				
				<div class="flex items-center gap-4">
					<div class="relative w-12 h-12">
						<svg class="w-12 h-12 -rotate-90">
							<circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" class="text-gray-800"/>
							<circle id="pro-ring" cx="24" cy="24" r="20" stroke="currentColor" stroke-width="4" fill="transparent" stroke-dasharray="125.6" stroke-dashoffset="125.6" class="text-green-500 transition-all duration-1000"/>
						</svg>
						<div class="absolute inset-0 flex items-center justify-center">
							<span class="text-[10px]">ðŸ’ª</span>
						</div>
					</div>
					<div>
						<p id="summary-pro" class="text-lg font-black leading-none">0g</p>
						<p class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">Protein</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Navigation List (iOS Style) -->
		<div class="space-y-4">
			<a href="/FirstRep/planner" class="group flex items-center justify-between bg-gray-900 border border-gray-800 p-5 rounded-2xl active:scale-[0.98] transition shadow-sm hover:border-indigo-500/30">
				<div class="flex items-center gap-4">
					<div class="w-10 h-10 bg-indigo-500/10 text-indigo-400 rounded-xl flex items-center justify-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
						</svg>
					</div>
					<div>
						<p class="font-bold text-gray-100">Workout Planner</p>
						<p class="text-xs text-gray-500">AI-customized training plans</p>
					</div>
				</div>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 group-hover:text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
				</svg>
			</a>

			<a href="/FirstRep/macros" class="group flex items-center justify-between bg-gray-900 border border-gray-800 p-5 rounded-2xl active:scale-[0.98] transition shadow-sm hover:border-green-500/30">
				<div class="flex items-center gap-4">
					<div class="w-10 h-10 bg-green-500/10 text-green-400 rounded-xl flex items-center justify-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
						</svg>
					</div>
					<div>
						<p class="font-bold text-gray-100">Calories & Macros</p>
						<p class="text-xs text-gray-500">Log meals and track targets</p>
					</div>
				</div>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 group-hover:text-green-400" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
				</svg>
			</a>

			<a href="/FirstRep/weight" class="group flex items-center justify-between bg-gray-900 border border-gray-800 p-5 rounded-2xl active:scale-[0.98] transition shadow-sm hover:border-yellow-500/30">
				<div class="flex items-center gap-4">
					<div class="w-10 h-10 bg-yellow-500/10 text-yellow-400 rounded-xl flex items-center justify-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
						</svg>
					</div>
					<div>
						<p class="font-bold text-gray-100">Weight Tracking</p>
						<p class="text-xs text-gray-500">Monitor progress and trends</p>
					</div>
				</div>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 group-hover:text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
				</svg>
			</a>
		</div>

		<!-- Settings / Logout Bottom -->
		<div class="mt-12 pt-8 border-t border-gray-800">
			<button id="btn-logout" class="w-full flex items-center justify-center gap-2 text-gray-500 hover:text-red-400 transition text-sm font-bold py-2">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
				</svg>
				Sign Out
			</button>
		</div>
	</main>

	<!-- Tab Bar (iOS Style) -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-xl border-t border-gray-800 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-indigo-500">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
				<path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
			</svg>
			<span class="text-[10px] font-bold">Home</span>
		</a>
		<a href="/FirstRep/planner" class="flex flex-col items-center gap-1 text-gray-500 hover:text-gray-300">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
			</svg>
			<span class="text-[10px] font-bold">Planner</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-500 hover:text-gray-300">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[10px] font-bold">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const logoutBtn = document.getElementById('btn-logout');
	const dateDisplay = document.getElementById('date-display');

	// Summary stats
	const sumCals = document.getElementById('summary-cals');
	const sumPro = document.getElementById('summary-pro');
	const calRing = document.getElementById('cal-ring') as unknown as SVGCircleElement;
	const proRing = document.getElementById('pro-ring') as unknown as SVGCircleElement;

	async function init() {
		const { data: { session }, error } = await supabase.auth.getSession();
		
		if (error || !session) {
			console.log("No session found, redirecting to login...");
			window.location.href = '/FirstRep/login';
			return;
		}

		const user = session.user;
		const today = new Date();
		// UI Setup
		dateDisplay.innerText = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

		// Fetch Today's Totals from Cloud
		const todayStr = today.toISOString().split('T')[0];
		const { data: logs } = await supabase
			.from('food_logs')
			.select('calories, protein')
			.eq('logged_at', todayStr);

		if (logs) {
			const totalCals = logs.reduce((acc, log) => acc + log.calories, 0);
			const totalPro = logs.reduce((acc, log) => acc + log.protein, 0);

			sumCals.innerText = Math.round(totalCals).toString();
			sumPro.innerText = Math.round(totalPro) + 'g';

			// Update Rings (Dash offset logic)
			const targetCals = 2500;
			const targetPro = 180;
			const circumference = 2 * Math.PI * 20; // 125.6

			const calOffset = circumference - (Math.min(totalCals / targetCals, 1) * circumference);
			const proOffset = circumference - (Math.min(totalPro / targetPro, 1) * circumference);

			setTimeout(() => {
				if (calRing) calRing.style.strokeDashoffset = calOffset.toString();
				if (proRing) proRing.style.strokeDashoffset = proOffset.toString();
			}, 100);
		}
	}

	logoutBtn?.addEventListener('click', async () => {
		await supabase.auth.signOut();
		window.location.href = '/FirstRep/login';
	});

	init();
</script>
