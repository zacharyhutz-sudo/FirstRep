---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Track Weight & Burn">
	<main class="max-w-md mx-auto px-6 py-8 pb-32">
		<header class="flex justify-between items-end mb-8">
			<div>
				<p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-1">Measurements</p>
				<h1 class="text-3xl font-black text-white italic tracking-tighter">Weight & Burn</h1>
			</div>
		</header>

		<!-- Log Entry Card -->
		<div class="bg-gray-900 border border-gray-800 rounded-[2.5rem] p-8 mb-8">
			<form id="log-form" class="space-y-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest block">Entry Date</label>
                    <input 
                        type="date" 
                        id="entry-date" 
                        class="bg-gray-950 border border-gray-800 rounded-lg px-3 py-1 text-[10px] font-black text-indigo-400 uppercase focus:outline-none"
                    />
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 block">Body Weight</label>
                    <div class="relative">
                        <input 
                            type="number" 
                            step="0.1" 
                            id="weight-input" 
                            placeholder="00.0" 
                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl px-6 py-5 text-3xl font-black text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-center"
                            required
                        />
                        <span id="unit-label" class="absolute right-6 top-1/2 -translate-y-1/2 text-sm font-black text-gray-700 uppercase tracking-widest">LBS</span>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 block">Calories Burned</label>
                    <div class="relative">
                        <input 
                            type="number" 
                            id="burn-input" 
                            placeholder="0" 
                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl px-6 py-5 text-3xl font-black text-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-center"
                            required
                        />
                        <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-gray-700 uppercase tracking-widest">KCAL</span>
                    </div>
                </div>

				<button type="submit" id="save-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-500/20 transition active:scale-95 tracking-widest uppercase italic text-sm">
					Save Entry
				</button>
			</form>
		</div>

		<!-- Custom Line Chart -->
		<section class="mb-8">
			<h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-6">Progress (Last 7 Days)</h3>
            <div class="bg-gray-900/40 border border-gray-800/50 rounded-[2rem] p-6 h-64 relative overflow-hidden flex flex-col justify-between">
                <!-- SVG Line Chart -->
                <div class="flex-1 relative">
                    <svg id="progress-chart" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                        <path id="weight-line" fill="none" stroke="#4f46e5" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="transition-all duration-1000" />
                        <path id="burn-line" fill="none" stroke="#818cf8" stroke-width="2" stroke-dasharray="4 4" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 transition-all duration-1000" />
                    </svg>
                </div>
                <!-- X-Axis Labels -->
                <div id="chart-labels" class="flex justify-between mt-4">
                    <!-- Labels injected -->
                </div>
            </div>
            <div class="flex justify-center gap-6 mt-4">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-0.5 bg-indigo-500"></span>
                    <span class="text-[10px] font-black text-gray-500 uppercase">Weight</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-0.5 bg-indigo-400 border-t border-dashed border-gray-900"></span>
                    <span class="text-[10px] font-black text-gray-500 uppercase">Burn</span>
                </div>
            </div>
		</section>

		<!-- History -->
		<section>
			<h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-6">History</h3>
			<div id="weight-history" class="space-y-3">
				<!-- Injected by JS -->
				<div class="animate-pulse bg-gray-900/40 h-16 rounded-2xl"></div>
			</div>
		</section>
	</main>

	<!-- Unified Nav -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-gray-800/50 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Log</span>
		</a>
		<a href="/FirstRep/weight" class="flex flex-col items-center gap-1 text-indigo-400 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2M8 21V5a2 2 0 012-2h4a2 2 0 012 2v16H8z" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Weight</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const form = document.getElementById('log-form');
	const weightInput = document.getElementById('weight-input') as HTMLInputElement;
	const burnInput = document.getElementById('burn-input') as HTMLInputElement;
    const dateInput = document.getElementById('entry-date') as HTMLInputElement;
    const saveBtn = document.getElementById('save-btn');
	const historyList = document.getElementById('weight-history');
	const unitLabel = document.getElementById('unit-label');
    const chartLabels = document.getElementById('chart-labels');
    const weightLine = document.getElementById('weight-line');
    const burnLine = document.getElementById('burn-line');

    let allLogs = [];

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) return window.location.href = '/FirstRep/login/index.html';

		const unit = localStorage.getItem('weightUnit') || 'lbs';
		if (unitLabel) unitLabel.innerText = unit.toUpperCase();

        // Default to today
        dateInput.value = new Date().toISOString().split('T')[0];

		await loadHistory();

        // If date changes, check if we have an existing entry to pre-fill
        dateInput.addEventListener('change', () => {
            const existing = allLogs.find(l => l.logged_at === dateInput.value);
            if (existing) {
                weightInput.value = existing.weight.toString();
                burnInput.value = (existing.calories_burned || 0).toString();
                saveBtn.innerText = 'Update Entry';
            } else {
                weightInput.value = '';
                burnInput.value = '';
                saveBtn.innerText = 'Save Entry';
            }
        });
	}

	async function loadHistory() {
		const { data: { user } } = await supabase.auth.getUser();
		const { data: logs } = await supabase
			.from('weight_logs')
			.select('*')
			.eq('user_id', user.id)
			.order('logged_at', { ascending: false })
			.limit(10);

		if (historyList) {
            allLogs = logs || [];
			if (logs && logs.length > 0) {
				historyList.innerHTML = logs.map(log => {
					const date = new Date(log.logged_at);
					return `
						<div class="bg-gray-900/40 border border-gray-800/50 p-4 rounded-2xl flex justify-between items-center group">
							<div>
								<p class="text-[10px] font-black text-gray-600 uppercase tracking-tighter">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
								<p class="font-bold text-gray-300">${log.weight} ${log.unit} â€¢ <span class="text-indigo-400">${log.calories_burned || 0} kcal</span></p>
							</div>
                            <button class="edit-past-btn opacity-0 group-hover:opacity-100 p-2 text-gray-700 hover:text-indigo-400 transition" data-date="${log.logged_at}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
						</div>
					`;
				}).join('');

                document.querySelectorAll('.edit-past-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const date = btn.getAttribute('data-date');
                        const entry = allLogs.find(l => l.logged_at === date);
                        if (entry) {
                            dateInput.value = entry.logged_at;
                            weightInput.value = entry.weight.toString();
                            burnInput.value = (entry.calories_burned || 0).toString();
                            saveBtn.innerText = 'Update Entry';
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });

                renderLineChart(logs.slice(0, 7));
			} else {
				historyList.innerHTML = `<p class="text-xs text-gray-600 font-bold text-center py-4 italic">No entries yet.</p>`;
			}
		}
	}

    function renderLineChart(logs) {
        const data = [...logs].reverse();
        if (data.length < 2) return;

        const width = 300; 
        const height = 150; 

        const weights = data.map(l => l.weight);
        const minW = Math.min(...weights) - 2;
        const maxW = Math.max(...weights) + 2;
        const wRange = maxW - minW;

        const burns = data.map(l => l.calories_burned || 0);
        const minB = Math.min(...burns) - 50;
        const maxB = Math.max(...burns) + 50;
        const bRange = maxB - minB;

        const getY = (val, min, range) => height - ((val - min) / range) * height;

        let wPath = `M 0 ${getY(weights[0], minW, wRange)}`;
        let bPath = `M 0 ${getY(burns[0], minB, bRange)}`;

        data.forEach((log, i) => {
            const x = (i / (data.length - 1)) * 100;
            wPath += ` L ${x} ${getY(log.weight, minW, wRange)}`;
            bPath += ` L ${x} ${getY(log.calories_burned || 0, minB, bRange)}`;
        });

        if (weightLine) weightLine.setAttribute('d', wPath);
        if (burnLine) burnLine.setAttribute('d', bPath);

        if (chartLabels) {
            chartLabels.innerHTML = data.map(l => `
                <span class="text-[8px] font-black text-gray-600 uppercase">
                    ${new Date(l.logged_at).toLocaleDateString('en-US', { day: 'numeric' })}
                </span>
            `).join('');
        }
    }

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const weight = parseFloat(weightInput.value);
		const burn = parseInt(burnInput.value);
		const unit = localStorage.getItem('weightUnit') || 'lbs';
        const dateKey = dateInput.value;

		const { data: { user } } = await supabase.auth.getUser();
		if (!user) return;

		const { error } = await supabase.from('weight_logs').upsert({
			user_id: user.id,
			weight: weight,
			calories_burned: burn,
			unit: unit,
			logged_at: dateKey
		}, { onConflict: 'user_id,logged_at' });

		if (!error) {
			weightInput.value = '';
			burnInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];
            saveBtn.innerText = 'Save Entry';
			await loadHistory();
		} else {
            console.error("Save Error:", error);
			alert('Error logging entry: ' + error.message);
		}
	});

	init();
</script>
