---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Track Weight & Burn">
	<main class="max-w-md mx-auto px-6 py-8 pb-32">
		<header class="flex justify-between items-end mb-8">
			<div>
				<p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-1">Measurements</p>
				<h1 class="text-3xl font-black text-white italic tracking-tighter">Weight & Burn</h1>
			</div>
		</header>

		<!-- Log Entry Card -->
		<div class="bg-gray-900 border border-gray-800 rounded-[2.5rem] p-8 mb-8">
			<form id="log-form" class="space-y-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest block">Entry Date</label>
                    <input 
                        type="date" 
                        id="entry-date" 
                        class="bg-gray-950 border border-gray-800 rounded-lg px-3 py-1 text-[10px] font-black text-indigo-400 uppercase focus:outline-none"
                    />
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 block">Body Weight</label>
                    <div class="relative">
                        <input 
                            type="number" 
                            step="0.1" 
                            id="weight-input" 
                            placeholder="00.0" 
                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl px-6 py-5 text-3xl font-black text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-center"
                            required
                        />
                        <span id="unit-label" class="absolute right-6 top-1/2 -translate-y-1/2 text-sm font-black text-gray-700 uppercase tracking-widest">LBS</span>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 block">Calories Burned</label>
                    <div class="relative">
                        <input 
                            type="number" 
                            id="burn-input" 
                            placeholder="0" 
                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl px-6 py-5 text-3xl font-black text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500/20 text-center"
                            required
                        />
                        <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-gray-700 uppercase tracking-widest">KCAL</span>
                    </div>
                </div>

				<button type="submit" id="save-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-500/20 transition active:scale-95 tracking-widest uppercase italic text-sm">
					Save Entry
				</button>
			</form>
		</div>

		<!-- Advanced Chart Section -->
		<section class="mb-8">
            <div class="flex justify-between items-end mb-6 px-1">
			    <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest">Performance Chart</h3>
                <div class="flex bg-gray-900 p-1 rounded-xl border border-gray-800">
                    <button id="range-7" class="px-3 py-1 rounded-lg text-[8px] font-black uppercase tracking-widest transition-colors bg-indigo-600 text-white">7D</button>
                    <button id="range-30" class="px-3 py-1 rounded-lg text-[8px] font-black uppercase tracking-widest transition-colors text-gray-500">30D</button>
                </div>
            </div>
            <div class="bg-gray-900/40 border border-gray-800/50 rounded-[2rem] p-6 relative overflow-visible">
                <!-- Dual Axis Labels -->
                <div class="flex justify-between mb-4 px-2">
                    <div class="text-[8px] font-black text-indigo-400 uppercase tracking-widest">Weight (Left)</div>
                    <div class="text-[8px] font-black text-green-400 uppercase tracking-widest text-right">Burn (Right)</div>
                </div>

                <div class="h-48 relative px-8">
                    <!-- Y-Axis Ticks (Weight) -->
                    <div id="y-weight-ticks" class="absolute left-0 top-0 bottom-0 w-8 flex flex-col justify-between text-[7px] font-bold text-indigo-500/50 py-1"></div>
                    <!-- Y-Axis Ticks (Burn) -->
                    <div id="y-burn-ticks" class="absolute right-0 top-0 bottom-0 w-8 flex flex-col justify-between text-[7px] font-bold text-green-500/50 text-right py-1"></div>
                    
                    <!-- SVG Chart -->
                    <svg id="progress-chart" class="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <!-- Horizontal Grid Lines -->
                        <line x1="0" y1="0" x2="100" y2="0" stroke="white" stroke-opacity="0.05" stroke-width="0.5" />
                        <line x1="0" y1="25" x2="100" y2="25" stroke="white" stroke-opacity="0.05" stroke-width="0.5" />
                        <line x1="0" y1="50" x2="100" y2="50" stroke="white" stroke-opacity="0.05" stroke-width="0.5" />
                        <line x1="0" y1="75" x2="100" y2="75" stroke="white" stroke-opacity="0.05" stroke-width="0.5" />
                        <line x1="0" y1="100" x2="100" y2="100" stroke="white" stroke-opacity="0.05" stroke-width="0.5" />

                        <path id="weight-line" fill="none" stroke="#6366f1" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round" />
                        <path id="burn-line" fill="none" stroke="#22c55e" stroke-width="1" stroke-dasharray="2 2" stroke-linecap="round" stroke-linejoin="round" />
                        
                        <!-- Data Points -->
                        <g id="chart-points"></g>
                    </svg>
                </div>

                <!-- X-Axis Labels -->
                <div id="chart-labels" class="flex justify-between px-8 mt-4"></div>
            </div>

            <!-- 30 Day Averages -->
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-gray-900 border border-gray-800 rounded-3xl p-5">
                    <p class="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-1">30D Weight Avg</p>
                    <div class="flex items-baseline gap-1">
                        <span id="avg-weight" class="text-xl font-black text-white italic">--</span>
                        <span id="avg-weight-unit" class="text-[8px] font-bold text-gray-600 uppercase">lbs</span>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-3xl p-5">
                    <p class="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-1">30D Burn Avg</p>
                    <div class="flex items-baseline gap-1">
                        <span id="avg-burn" class="text-xl font-black text-green-400 italic">--</span>
                        <span class="text-[8px] font-bold text-gray-600 uppercase">kcal</span>
                    </div>
                </div>
            </div>
		</section>

		<!-- History -->
		<section>
			<h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-6">Recent History</h3>
			<div id="weight-history" class="space-y-3">
				<div class="animate-pulse bg-gray-900/40 h-16 rounded-2xl"></div>
			</div>
		</section>
	</main>

	<!-- Unified Nav -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-gray-800/50 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Log</span>
		</a>
		<a href="/FirstRep/weight" class="flex flex-col items-center gap-1 text-indigo-400 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2M8 21V5a2 2 0 012-2h4a2 2 0 012 2v16H8z" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Weight</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const form = document.getElementById('log-form');
	const weightInput = document.getElementById('weight-input') as HTMLInputElement;
	const burnInput = document.getElementById('burn-input') as HTMLInputElement;
    const dateInput = document.getElementById('entry-date') as HTMLInputElement;
    const saveBtn = document.getElementById('save-btn');
	const historyList = document.getElementById('weight-history');
	const unitLabel = document.getElementById('unit-label');
    const chartLabels = document.getElementById('chart-labels');
    const weightLine = document.getElementById('weight-line');
    const burnLine = document.getElementById('burn-line');
    const weightTicksEl = document.getElementById('y-weight-ticks');
    const burnTicksEl = document.getElementById('y-burn-ticks');
    const chartPoints = document.getElementById('chart-points');
    const avgWeightEl = document.getElementById('avg-weight');
    const avgBurnEl = document.getElementById('avg-burn');

    let allLogs = [];
    let chartRange = 7;

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) return window.location.href = '/FirstRep/login/index.html';

		const unit = localStorage.getItem('weightUnit') || 'lbs';
		if (unitLabel) unitLabel.innerText = unit.toUpperCase();
        const weightUnitEl = document.getElementById('avg-weight-unit');
        if (weightUnitEl) weightUnitEl.innerText = unit.toLowerCase();

        dateInput.value = new Date().toISOString().split('T')[0];
		await loadHistory();

        // Range Toggles
        const btn7 = document.getElementById('range-7');
        const btn30 = document.getElementById('range-30');

        btn7.addEventListener('click', () => {
            chartRange = 7;
            btn7.classList.add('bg-indigo-600', 'text-white');
            btn7.classList.remove('text-gray-500');
            btn30.classList.remove('bg-indigo-600', 'text-white');
            btn30.classList.add('text-gray-500');
            renderDualLineChart(allLogs.slice(0, 7).reverse());
        });

        btn30.addEventListener('click', () => {
            chartRange = 30;
            btn30.classList.add('bg-indigo-600', 'text-white');
            btn30.classList.remove('text-gray-500');
            btn7.classList.remove('bg-indigo-600', 'text-white');
            btn7.classList.add('text-gray-500');
            renderDualLineChart(allLogs.slice(0, 30).reverse());
        });

        dateInput.addEventListener('change', () => {
            const existing = allLogs.find(l => l.logged_at === dateInput.value);
            if (existing) {
                weightInput.value = existing.weight.toString();
                burnInput.value = (existing.calories_burned || 0).toString();
                saveBtn.innerText = 'Update Entry';
            } else {
                weightInput.value = '';
                burnInput.value = '';
                saveBtn.innerText = 'Save Entry';
            }
        });
	}

	async function loadHistory() {
		const { data: { user } } = await supabase.auth.getUser();
		const { data: logs } = await supabase
			.from('weight_logs')
			.select('*')
			.eq('user_id', user.id)
			.order('logged_at', { ascending: false })
			.limit(30);

		if (historyList) {
            allLogs = logs || [];
			if (logs && logs.length > 0) {
				historyList.innerHTML = logs.slice(0, 10).map(log => {
					const date = new Date(log.logged_at);
					return `
						<div class="bg-gray-900/40 border border-gray-800/50 p-4 rounded-2xl flex justify-between items-center group">
							<div>
								<p class="text-[10px] font-black text-gray-600 uppercase tracking-tighter">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
								<p class="font-bold text-gray-300">${log.weight} ${log.unit} â€¢ <span class="text-green-400">${log.calories_burned || 0} kcal</span></p>
							</div>
                            <button class="edit-past-btn opacity-0 group-hover:opacity-100 p-2 text-gray-700 hover:text-indigo-400 transition" data-date="${log.logged_at}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
						</div>
					`;
				}).join('');

                document.querySelectorAll('.edit-past-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const date = btn.getAttribute('data-date');
                        const entry = allLogs.find(l => l.logged_at === date);
                        if (entry) {
                            dateInput.value = entry.logged_at;
                            weightInput.value = entry.weight.toString();
                            burnInput.value = (entry.calories_burned || 0).toString();
                            saveBtn.innerText = 'Update Entry';
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });

                renderDualLineChart(logs.slice(0, chartRange).reverse());
                calculateAverages(logs);
			} else {
				historyList.innerHTML = `<p class="text-xs text-gray-600 font-bold text-center py-4 italic">No entries yet.</p>`;
			}
		}
	}

    function calculateAverages(logs) {
        if (!logs.length) return;
        const totalWeight = logs.reduce((acc, l) => acc + l.weight, 0);
        const totalBurn = logs.reduce((acc, l) => acc + (l.calories_burned || 0), 0);
        
        if (avgWeightEl) avgWeightEl.innerText = (totalWeight / logs.length).toFixed(1);
        if (avgBurnEl) avgBurnEl.innerText = Math.round(totalBurn / logs.length).toLocaleString();
    }

    function renderDualLineChart(data) {
        if (data.length < 2) return;

        // Configuration
        const height = 100; // viewBox height
        const padding = 2; // Offset from edges

        // Weight Range (Left Axis)
        const weights = data.map(l => l.weight);
        const minW = Math.min(...weights) - 2;
        const maxW = Math.max(...weights) + 2;
        const wRange = maxW - minW;

        // Burn Range (Right Axis)
        const burns = data.map(l => l.calories_burned || 0);
        const minB = Math.max(0, Math.min(...burns) - 100);
        const maxB = Math.max(...burns) + 100;
        const bRange = maxB - minB;

        // Set Y-Ticks
        if (weightTicksEl) {
            weightTicksEl.innerHTML = `
                <span>${maxW.toFixed(0)}</span>
                <span>${(minW + wRange * 0.75).toFixed(0)}</span>
                <span>${(minW + wRange * 0.5).toFixed(0)}</span>
                <span>${(minW + wRange * 0.25).toFixed(0)}</span>
                <span>${minW.toFixed(0)}</span>
            `;
        }
        if (burnTicksEl) {
            burnTicksEl.innerHTML = `
                <span>${maxB.toFixed(0)}</span>
                <span>${Math.round(minB + bRange * 0.75)}</span>
                <span>${Math.round(minB + bRange * 0.5)}</span>
                <span>${Math.round(minB + bRange * 0.25)}</span>
                <span>${minB.toFixed(0)}</span>
            `;
        }

        const getX = (i) => (i / (data.length - 1)) * 100;
        const getY = (val, min, range) => height - ((val - min) / range) * height;

        // Build Paths
        let wPath = `M ${getX(0)} ${getY(weights[0], minW, wRange)}`;
        let bPath = `M ${getX(0)} ${getY(burns[0], minB, bRange)}`;
        let circles = '';

        data.forEach((log, i) => {
            const x = getX(i);
            const yW = getY(log.weight, minW, wRange);
            const yB = getY(log.calories_burned || 0, minB, bRange);
            
            wPath += ` L ${x} ${yW}`;
            bPath += ` L ${x} ${yB}`;
            
            // Circles for clarity
            circles += `
                <circle cx="${x}" cy="${yW}" r="1.5" fill="#6366f1" />
                <circle cx="${x}" cy="${yB}" r="1.5" fill="#22c55e" />
            `;
        });

        if (weightLine) weightLine.setAttribute('d', wPath);
        if (burnLine) burnLine.setAttribute('d', bPath);
        if (chartPoints) chartPoints.innerHTML = circles;

        // Labels
        if (chartLabels) {
            // Only show labels for first, middle, and last to avoid crowding on 30D
            chartLabels.innerHTML = data.map((l, i) => {
                const isEdgeOrMid = i === 0 || i === data.length - 1 || (data.length > 10 && i === Math.floor(data.length / 2));
                return `
                    <span class="text-[8px] font-black text-gray-600 uppercase ${isEdgeOrMid ? '' : 'hidden sm:block'}">
                        ${new Date(l.logged_at + 'T00:00:00').toLocaleDateString('en-US', { day: 'numeric', month: data.length > 10 ? 'short' : undefined })}
                    </span>
                `;
            }).join('');
        }
    }

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const weight = parseFloat(weightInput.value);
		const burn = parseInt(burnInput.value);
		const unit = localStorage.getItem('weightUnit') || 'lbs';
        const dateKey = dateInput.value;

		const { data: { user } } = await supabase.auth.getUser();
		if (!user) return;

		const { error } = await supabase.from('weight_logs').upsert({
			user_id: user.id,
			weight: weight,
			calories_burned: burn,
			unit: unit,
			logged_at: dateKey
		}, { onConflict: 'user_id,logged_at' });

		if (!error) {
			weightInput.value = '';
			burnInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];
            saveBtn.innerText = 'Save Entry';
			await loadHistory();
		} else {
            console.error("Save Error:", error);
			alert('Error logging entry: ' + error.message);
		}
	});

	init();
</script>
