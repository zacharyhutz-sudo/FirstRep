---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Track Weight">
	<main class="max-w-md mx-auto px-6 py-8 pb-32">
		<header class="flex justify-between items-end mb-8">
			<div>
				<p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-1">Measurements</p>
				<h1 class="text-3xl font-black text-white italic tracking-tighter">Weight</h1>
			</div>
		</header>

		<!-- Log Weight Card -->
		<div class="bg-gray-900 border border-gray-800 rounded-[2.5rem] p-8 mb-8">
			<div class="flex items-center gap-4 mb-8">
				<div class="w-12 h-12 rounded-2xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
					</svg>
				</div>
				<div>
					<h2 class="text-lg font-bold text-white">Log Current Weight</h2>
					<p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Tracking Progress</p>
				</div>
			</div>

			<form id="weight-form" class="space-y-6">
				<div class="relative">
					<input 
						type="number" 
						step="0.1" 
						id="weight-input" 
						placeholder="00.0" 
						class="w-full bg-gray-950 border border-gray-800 rounded-2xl px-6 py-5 text-3xl font-black text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-center"
						required
					/>
					<span id="unit-label" class="absolute right-6 top-1/2 -translate-y-1/2 text-sm font-black text-gray-700 uppercase tracking-widest">LBS</span>
				</div>
				<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-500/20 transition active:scale-95 tracking-widest uppercase italic text-sm">
					Save Entry
				</button>
			</form>
		</div>

		<!-- History -->
		<section>
			<h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-6">History</h3>
			<div id="weight-history" class="space-y-3">
				<!-- Injected by JS -->
				<div class="animate-pulse bg-gray-900/40 h-16 rounded-2xl"></div>
				<div class="animate-pulse bg-gray-900/40 h-16 rounded-2xl"></div>
			</div>
		</section>
	</main>

	<!-- Unified Nav -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-gray-800/50 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Log</span>
		</a>
		<a href="/FirstRep/weight" class="flex flex-col items-center gap-1 text-indigo-400 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
				<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.599-.8a1 1 0 01.894 1.79l-1.233.616 1.738 5.42a1 1 0 01-.285 1.05A3.989 3.989 0 0115 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.715-5.349L11 6.477V16h2a1 1 0 110 2H7a1 1 0 110-2h2V6.477L6.237 7.582l1.715 5.349a1 1 0 01-.285 1.05A3.989 3.989 0 015 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.738-5.42-1.233-.616a1 1 0 11.894-1.79l1.599.8L9 4.323V3a1 1 0 011-1z" clip-rule="evenodd" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Weight</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const form = document.getElementById('weight-form');
	const input = document.getElementById('weight-input') as HTMLInputElement;
	const historyList = document.getElementById('weight-history');
	const unitLabel = document.getElementById('unit-label');

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) return window.location.href = '/FirstRep/login/index.html';

		const unit = localStorage.getItem('weightUnit') || 'lbs';
		if (unitLabel) unitLabel.innerText = unit.toUpperCase();

		await loadHistory();
	}

	async function loadHistory() {
		const { data: { user } } = await supabase.auth.getUser();
		const { data: logs } = await supabase
			.from('weight_logs')
			.select('*')
			.eq('user_id', user.id)
			.order('logged_at', { ascending: false })
			.limit(10);

		if (historyList) {
			if (logs && logs.length > 0) {
				historyList.innerHTML = logs.map(log => {
					const date = new Date(log.logged_at);
					return `
						<div class="bg-gray-900/40 border border-gray-800/50 p-4 rounded-2xl flex justify-between items-center">
							<div>
								<p class="text-[10px] font-black text-gray-600 uppercase tracking-tighter">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
								<p class="font-bold text-gray-300">${log.weight} ${log.unit}</p>
							</div>
						</div>
					`;
				}).join('');
			} else {
				historyList.innerHTML = `<p class="text-xs text-gray-600 font-bold text-center py-4 italic">No entries yet.</p>`;
			}
		}
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const weight = parseFloat(input.value);
		const unit = localStorage.getItem('weightUnit') || 'lbs';

		if (!weight) return;

		const { data: { user } } = await supabase.auth.getUser();
		if (!user) return;

		const { error } = await supabase.from('weight_logs').insert([{
			user_id: user.id,
			weight: weight,
			unit: unit,
			logged_at: new Date().toISOString().split('T')[0]
		}]);

		if (!error) {
			input.value = '';
			await loadHistory();
		} else {
			alert('Error logging weight: ' + error.message);
		}
	});

	init();
</script>
