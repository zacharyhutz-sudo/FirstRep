---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Workout Library">
	<main class="max-w-md mx-auto px-6 py-8 pb-32">
		<header class="flex justify-between items-end mb-8">
			<div>
				<p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-1">Training</p>
				<h1 class="text-3xl font-black text-white italic tracking-tighter">Workouts</h1>
			</div>
			<a href="/FirstRep/planner" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 active:scale-90 transition">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
				</svg>
			</a>
		</header>

		<!-- Active Plan Section -->
		<section class="mb-10">
			<h2 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">Active Plan</h2>
			<div id="active-plan-container">
				<!-- Injected by JS -->
				<div class="animate-pulse bg-gray-900 h-32 rounded-[2rem] border border-gray-800"></div>
			</div>
		</section>

		<!-- Library Section -->
		<section>
			<h2 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">My Library</h2>
			<div id="plans-grid" class="space-y-4">
				<!-- Injected by JS -->
			</div>
		</section>
	</main>

	<!-- Workout Preview Modal -->
	<div id="preview-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[60] flex items-end sm:items-center justify-center">
		<div class="bg-gray-950 w-full max-w-lg rounded-t-[2.5rem] sm:rounded-[2.5rem] overflow-hidden border-t border-gray-800 flex flex-col max-h-[90vh]">
			<div class="p-8 flex flex-col h-full overflow-hidden">
				<div class="flex justify-between items-start mb-6">
					<div class="flex-1 mr-4">
						<div class="flex items-center group">
							<h2 id="preview-name" class="text-3xl font-black text-white italic tracking-tighter">Workout Name</h2>
							<button id="edit-name-btn" class="ml-3 p-2 text-gray-600 hover:text-indigo-400 transition opacity-0 group-hover:opacity-100 focus:opacity-100">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
									<path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
								</svg>
							</button>
						</div>
						<!-- Inline Edit Input -->
						<div id="edit-name-container" class="hidden flex items-center gap-2 mt-1">
							<input type="text" id="edit-name-input" class="bg-gray-900 border border-indigo-500/50 rounded-xl px-4 py-2 text-white font-bold text-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500/20" />
							<button id="save-name-btn" class="bg-indigo-600 text-white p-2 rounded-xl active:scale-90 transition">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
									<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
								</svg>
							</button>
						</div>
						<p id="preview-meta" class="text-xs font-bold text-indigo-400 uppercase tracking-widest mt-1">6 Exercises • 45 Min</p>
					</div>
					<button id="close-preview" class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center text-gray-400 active:scale-90 transition shrink-0">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>

				<div id="preview-exercises" class="flex-1 overflow-y-auto space-y-4 pr-2 no-scrollbar mb-8">
					<!-- Exercises listed here -->
				</div>

				<div class="flex flex-col gap-3">
					<button id="set-active-btn" class="w-full bg-gray-900 border border-gray-800 text-gray-300 font-black py-4 rounded-2xl active:scale-95 transition tracking-widest uppercase text-xs">
						Set as Active Plan
					</button>
					<button id="start-workout-btn" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-500/20 active:scale-95 transition tracking-widest uppercase italic text-sm">
						Start Session
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Nav Bar -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-gray-800/50 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-indigo-400 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
				<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
				<path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Log</span>
		</a>
		<a href="/FirstRep/weight" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2M8 21V5a2 2 0 012-2h4a2 2 0 012 2v16H8z" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Weight</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-600 hover:text-gray-300 transition">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const plansGrid = document.getElementById('plans-grid');
	const activeContainer = document.getElementById('active-plan-container');
	const previewModal = document.getElementById('preview-modal');
	const previewName = document.getElementById('preview-name');
	const previewMeta = document.getElementById('preview-meta');
	const previewExercises = document.getElementById('preview-exercises');
	const startBtn = document.getElementById('start-workout-btn');
	const setActiveBtn = document.getElementById('set-active-btn');
	const closePreview = document.getElementById('close-preview');

	const editNameBtn = document.getElementById('edit-name-btn');
	const editNameContainer = document.getElementById('edit-name-container');
	const editNameInput = document.getElementById('edit-name-input') as HTMLInputElement;
	const saveNameBtn = document.getElementById('save-name-btn');

	let selectedPlan = null;
	let allPlans = [];
	let nextRecommendedDayIdx = 0;

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) return window.location.href = '/FirstRep/login/index.html';

		await loadPlans();
	}

	async function loadPlans() {
		const { data: { user } } = await supabase.auth.getUser();
		const { data: plans } = await supabase
			.from('workout_plans')
			.select('*')
			.eq('user_id', user.id)
			.order('created_at', { ascending: false });

		if (!plans) return;
		allPlans = plans;

		// Fetch last completed workout to highlight current day
		const { data: lastWorkout } = await supabase
			.from('completed_workouts')
			.select('workout_name, completed_at')
			.eq('user_id', user.id)
			.order('completed_at', { ascending: false })
			.limit(1)
			.maybeSingle();

		plansGrid.innerHTML = '';
		const activePlan = plans.find(p => p.is_active);
		
		// Render Active Plan Card
		if (activePlan) {
			activeContainer.innerHTML = createPlanCard(activePlan, true);
		} else {
			activeContainer.innerHTML = `
				<div class="bg-gray-900 border border-gray-800 border-dashed rounded-[2rem] p-8 text-center">
					<p class="text-sm text-gray-500 font-bold">No active plan. Select a workout below to start.</p>
				</div>
			`;
		}

		// Render Library
		plans.forEach(plan => {
			if (!plan.is_active) {
				plansGrid.innerHTML += createPlanCard(plan, false);
			}
		});

		// Attach Listeners
		document.querySelectorAll('.plan-card').forEach(card => {
			card.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				if (target.closest('.delete-btn')) return;
				const planId = card.getAttribute('data-id');
				const plan = allPlans.find(p => p.id === planId);
				if (plan) openPreview(plan, lastWorkout);
			});
		});

		document.querySelectorAll('.delete-btn').forEach(btn => {
			btn.addEventListener('click', async (e) => {
				e.stopPropagation();
				if (!confirm('Delete this workout plan forever?')) return;
				const planId = btn.getAttribute('data-id');
				if (planId) {
					await supabase.from('workout_plans').delete().eq('id', planId);
					loadPlans();
				}
			});
		});
	}

	function createPlanCard(plan, isActive) {
		const exercises = plan.exercises || [];
		return `
			<div class="plan-card group relative bg-gray-900 border ${isActive ? 'border-indigo-500/50 shadow-lg shadow-indigo-500/10' : 'border-gray-800'} rounded-[2rem] p-6 cursor-pointer active:scale-[0.98] transition" data-id="${plan.id}">
				<div class="flex justify-between items-start">
					<div class="flex-1">
						<div class="flex items-center gap-2 mb-1">
							<h3 class="text-xl font-black text-white italic tracking-tight">${plan.plan_name}</h3>
							${isActive ? '<span class="bg-indigo-600 text-[8px] font-black uppercase px-2 py-0.5 rounded-full text-white tracking-widest">Active</span>' : ''}
						</div>
						<p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${exercises.length} Exercises • ~45 Min</p>
					</div>
					<button class="delete-btn p-2 text-gray-700 hover:text-red-500 transition" data-id="${plan.id}">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>
				${isActive ? `
					<div class="mt-4 flex items-center gap-2 text-indigo-400 font-bold text-[10px] uppercase tracking-widest">
						<span class="flex h-1.5 w-1.5 rounded-full bg-indigo-400"></span>
						Ready for session
					</div>
				` : ''}
			</div>
		`;
	}

	function openPreview(plan, lastWorkout = null) {
		selectedPlan = plan;
		previewName.innerText = plan.plan_name;
		previewName.classList.remove('hidden');
		editNameContainer.classList.add('hidden');
		
		const planData = plan.plan_data || {};
		const days = planData.days || planData.workouts || [];
		
		previewMeta.innerText = `${days.length} Day Program`;

		// Determine which day to highlight
		nextRecommendedDayIdx = 0;
		if (lastWorkout && lastWorkout.workout_name.startsWith(plan.plan_name)) {
			const lastDayLabel = lastWorkout.workout_name.split(' - ')[1];
			const lastIdx = days.findIndex(d => (d.day_label || d.label) === lastDayLabel);
			if (lastIdx !== -1) nextRecommendedDayIdx = (lastIdx + 1) % days.length;
		}
		
		if (days.length > 0) {
			previewExercises.innerHTML = days.map((day, idx) => {
				const isCurrent = idx === nextRecommendedDayIdx;
				return `
					<div class="day-section space-y-3 mb-6 p-4 rounded-2xl transition-colors ${isCurrent ? 'bg-indigo-500/10 border border-indigo-500/20' : ''}" data-day-idx="${idx}">
						<div class="flex justify-between items-center px-2">
							<div class="flex items-center gap-2">
								<span class="text-[10px] font-black ${isCurrent ? 'text-indigo-400' : 'text-gray-500'} uppercase tracking-widest">${day.day_label || day.label || `Day ${idx + 1}`}</span>
								${isCurrent ? '<span class="bg-indigo-600 text-[7px] font-black uppercase px-1.5 py-0.5 rounded text-white tracking-widest">Recommended Next</span>' : ''}
							</div>
							<button class="start-day-btn bg-gray-800 hover:bg-indigo-600 text-white text-[9px] font-black uppercase px-3 py-1 rounded-full transition" data-id="${plan.id}" data-day="${idx}">
								Start This Day
							</button>
						</div>
						<div class="space-y-2">
							${(day.exercises || []).map(ex => `
								<div class="flex items-center gap-3 py-1 border-b border-gray-800/30 last:border-0">
									<div class="text-[10px] font-black text-gray-700 w-4">${ex.sets}x</div>
									<div class="text-sm font-medium text-gray-300">${ex.exercise || ex.exercise_name || ex.name}</div>
								</div>
							`).join('')}
						</div>
					</div>
				`;
			}).join('');

			// Attach mini-start buttons
			document.querySelectorAll('.start-day-btn').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const id = btn.getAttribute('data-id');
					const day = btn.getAttribute('data-day');
					
					// Set active
					const { data: { user } } = await supabase.auth.getUser();
					await supabase.from('workout_plans').update({ is_active: false }).eq('user_id', user.id);
					await supabase.from('workout_plans').update({ is_active: true }).eq('id', id);
					
					window.location.href = `/FirstRep/session?id=${id}&day=${day}`;
				});
			});
		}

		setActiveBtn.innerText = plan.is_active ? 'Currently Active' : 'Set as Active Plan';
		setActiveBtn.disabled = plan.is_active;

		previewModal.classList.remove('hidden');
	}

	// Edit Name Handlers
	editNameBtn.addEventListener('click', () => {
		previewName.classList.add('hidden');
		editNameContainer.classList.remove('hidden');
		editNameInput.value = selectedPlan.plan_name;
		editNameInput.focus();
	});

	saveNameBtn.addEventListener('click', async () => {
		const newName = editNameInput.value.trim();
		if (!newName || !selectedPlan) return;

		const { error } = await supabase
			.from('workout_plans')
			.update({ plan_name: newName })
			.eq('id', selectedPlan.id);

		if (!error) {
			selectedPlan.plan_name = newName;
			previewName.innerText = newName;
			previewName.classList.remove('hidden');
			editNameContainer.classList.add('hidden');
			loadPlans();
		}
	});

	setActiveBtn.addEventListener('click', async () => {
		if (!selectedPlan) return;
		
		const { data: { user } } = await supabase.auth.getUser();
		await supabase.from('workout_plans').update({ is_active: false }).eq('user_id', user.id);
		await supabase.from('workout_plans').update({ is_active: true }).eq('id', selectedPlan.id);

		setActiveBtn.innerText = 'Activated!';
		loadPlans();
		setTimeout(() => {
			previewModal.classList.add('hidden');
		}, 600);
	});

	startBtn.addEventListener('click', async () => {
		if (!selectedPlan) return;
		
		const { data: { user } } = await supabase.auth.getUser();
		await supabase.from('workout_plans').update({ is_active: false }).eq('user_id', user.id);
		await supabase.from('workout_plans').update({ is_active: true }).eq('id', selectedPlan.id);

		// FIX: Use the nextRecommendedDayIdx calculated in openPreview
		window.location.href = `/FirstRep/session?id=${selectedPlan.id}&day=${nextRecommendedDayIdx}`;
	});

	closePreview.addEventListener('click', () => {
		previewModal.classList.add('hidden');
	});

	init();
</script>
