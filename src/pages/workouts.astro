---
import Layout from '../layouts/Layout.astro';
---

<Layout title="FirstRep - Workout Library">
	<main class="max-w-md mx-auto px-6 py-8 pb-32">
		<header class="flex justify-between items-end mb-8">
			<div>
				<p class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-1">Training</p>
				<h1 class="text-3xl font-black text-white italic tracking-tighter">Workouts</h1>
			</div>
			<a href="/FirstRep/planner" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 active:scale-90 transition">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
				</svg>
			</a>
		</header>

		<!-- Active Plan Section -->
		<section class="mb-10">
			<h2 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">Active Plan</h2>
			<div id="active-plan-container">
				<!-- Injected by JS -->
				<div class="animate-pulse bg-gray-900 h-32 rounded-[2rem] border border-gray-800"></div>
			</div>
		</section>

		<!-- Library Section -->
		<section>
			<h2 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">My Library</h2>
			<div id="plans-grid" class="space-y-4">
				<!-- Injected by JS -->
			</div>
		</section>
	</main>

	<!-- Workout Preview Modal -->
	<div id="preview-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[60] flex items-end sm:items-center justify-center">
		<div class="bg-gray-950 w-full max-w-lg rounded-t-[2.5rem] sm:rounded-[2.5rem] overflow-hidden border-t border-gray-800 flex flex-col max-h-[90vh]">
			<div class="p-8 flex flex-col h-full overflow-hidden">
				<div class="flex justify-between items-start mb-6">
					<div>
						<h2 id="preview-name" class="text-3xl font-black text-white italic tracking-tighter">Workout Name</h2>
						<p id="preview-meta" class="text-xs font-bold text-indigo-400 uppercase tracking-widest mt-1">6 Exercises • 45 Min</p>
					</div>
					<button id="close-preview" class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center text-gray-400">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>

				<div id="preview-exercises" class="flex-1 overflow-y-auto space-y-4 pr-2 no-scrollbar mb-8">
					<!-- Exercises listed here -->
				</div>

				<button id="start-workout-btn" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-500/20 active:scale-95 transition tracking-widest uppercase italic text-sm">
					Start Session
				</button>
			</div>
		</div>
	</div>

	<!-- Nav Bar -->
	<nav class="fixed bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-gray-800/50 px-6 py-3 flex justify-around items-center z-50">
		<a href="/FirstRep/" class="flex flex-col items-center gap-1 text-gray-600">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Home</span>
		</a>
		<a href="/FirstRep/workouts" class="flex flex-col items-center gap-1 text-indigo-400">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
				<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
				<path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Log</span>
		</a>
		<a href="/FirstRep/macros" class="flex flex-col items-center gap-1 text-gray-600">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
			</svg>
			<span class="text-[9px] font-black uppercase tracking-tighter">Macros</span>
		</a>
	</nav>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const plansGrid = document.getElementById('plans-grid');
	const activeContainer = document.getElementById('active-plan-container');
	const previewModal = document.getElementById('preview-modal');
	const previewName = document.getElementById('preview-name');
	const previewMeta = document.getElementById('preview-meta');
	const previewExercises = document.getElementById('preview-exercises');
	const startBtn = document.getElementById('start-workout-btn');
	const closePreview = document.getElementById('close-preview');

	let selectedPlan = null;

	async function init() {
		const { data: { session } } = await supabase.auth.getSession();
		if (!session) return window.location.href = '/FirstRep/login/index.html';

		await loadPlans();
	}

	async function loadPlans() {
		const { data: { user } } = await supabase.auth.getUser();
		const { data: plans } = await supabase
			.from('workout_plans')
			.select('*')
			.eq('user_id', user.id)
			.order('created_at', { ascending: false });

		if (!plans) return;

		plansGrid.innerHTML = '';
		const activePlan = plans.find(p => p.is_active);
		
		// Render Active Plan Card
		if (activePlan) {
			activeContainer.innerHTML = createPlanCard(activePlan, true);
		} else {
			activeContainer.innerHTML = `
				<div class="bg-gray-900 border border-gray-800 border-dashed rounded-[2rem] p-8 text-center">
					<p class="text-sm text-gray-500 font-bold">No active plan. Select a workout below to start.</p>
				</div>
			`;
		}

		// Render Library
		plans.forEach(plan => {
			if (!plan.is_active) {
				plansGrid.innerHTML += createPlanCard(plan, false);
			}
		});

		// Attach Listeners
		document.querySelectorAll('.plan-card').forEach(card => {
			card.addEventListener('click', (e) => {
				if ((e.target as HTMLElement).closest('.delete-btn')) return;
				const planId = card.getAttribute('data-id');
				const plan = plans.find(p => p.id === planId);
				openPreview(plan);
			});
		});

		document.querySelectorAll('.delete-btn').forEach(btn => {
			btn.addEventListener('click', async (e) => {
				e.stopPropagation();
				if (!confirm('Delete this workout plan forever?')) return;
				const planId = btn.getAttribute('data-id');
				await supabase.from('workout_plans').delete().eq('id', planId);
				loadPlans();
			});
		});
	}

	function createPlanCard(plan, isActive) {
		const exercises = plan.exercises || [];
		return `
			<div class="plan-card group relative bg-gray-900 border ${isActive ? 'border-indigo-500/50 shadow-lg shadow-indigo-500/10' : 'border-gray-800'} rounded-[2rem] p-6 cursor-pointer active:scale-[0.98] transition" data-id="${plan.id}">
				<div class="flex justify-between items-start">
					<div class="flex-1">
						<div class="flex items-center gap-2 mb-1">
							<h3 class="text-xl font-black text-white italic tracking-tight">${plan.plan_name}</h3>
							${isActive ? '<span class="bg-indigo-600 text-[8px] font-black uppercase px-2 py-0.5 rounded-full text-white tracking-widest">Active</span>' : ''}
						</div>
						<p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${exercises.length} Exercises • ~45 Min</p>
					</div>
					<button class="delete-btn p-2 text-gray-700 hover:text-red-500 transition" data-id="${plan.id}">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>
				${isActive ? `
					<div class="mt-4 flex items-center gap-2 text-indigo-400 font-bold text-[10px] uppercase tracking-widest">
						<span class="flex h-1.5 w-1.5 rounded-full bg-indigo-400"></span>
						Ready for session
					</div>
				` : ''}
			</div>
		`;
	}

	function openPreview(plan) {
		selectedPlan = plan;
		previewName.innerText = plan.plan_name;
		previewMeta.innerText = `${plan.exercises?.length || 0} Exercises • ~45 Min`;
		
		previewExercises.innerHTML = (plan.exercises || []).map(ex => `
			<div class="bg-gray-900/50 border border-gray-800 p-4 rounded-2xl flex items-center gap-4">
				<div class="w-10 h-10 rounded-xl bg-gray-800 flex items-center justify-center text-gray-500 font-black italic">
					${ex.sets}
				</div>
				<div>
					<p class="font-bold text-gray-200">${ex.exercise_name}</p>
					<p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${ex.reps} Reps • ${ex.sets} Sets</p>
				</div>
			</div>
		`).join('');

		previewModal.classList.remove('hidden');
	}

	startBtn.addEventListener('click', async () => {
		if (!selectedPlan) return;
		
		// Mark as active in Supabase
		const { data: { user } } = await supabase.auth.getUser();
		await supabase.from('workout_plans').update({ is_active: false }).eq('user_id', user.id);
		await supabase.from('workout_plans').update({ is_active: true }).eq('id', selectedPlan.id);

		// Redirect to new session logger (to be built)
		window.location.href = `/FirstRep/session?id=${selectedPlan.id}`;
	});

	closePreview.addEventListener('click', () => {
		previewModal.classList.add('hidden');
	});

	init();
</script>
